create or replace PACKAGE BODY POS_GIFT_CARD_DIFF_PKG
/**************************************************************** 
      This package is used to Compare the Legacy GIFT CARD Transaction file to the 
      POS table driven GIFT CARD Transaction data load
      and get the Differance files created.
          
created : 11/04/2016 AXK326 CCN Team...
changed : 
*****************************************************************/
AS
g_char                              VARCHAR2(1) := 'X';
g_schema                            VARCHAR2(10) := 'BANKING';
g_separator                         VARCHAR2(1) := ',';


PROCEDURE POS_GIFT_CARD_DIFF_sp
/*********************************************************************** 
        This Procedure is used compare the legacy GIFT CARD Transaction file 
        and the POS GIFT CARD Transaction data and creats a Difference file.
        
created : 11/04/2016 AXK326 CCN Team...
changed : 12/08/2016 vxv336 Modified join conditions in c_legacy cursor
          12/19/2016 vxv336 Load DIFF records into GIFT_CARD_RECONCILE_DATA table
************************************************************************/
IS

CURSOR c_legacy IS
SELECT FF.TRANSACTION_TYPE TRANSACTION_TYPE1 
      ,FF.GIFT_CARD_NBR GIFT_CARD_NBR1 
      ,FF.DIVISION_NBR DIVISION_NBR1 
      ,FF.DISTRICT_NBR DISTRICT_NBR1 
      ,FF.AREA_NBR AREA_NBR1 
      ,FF.STORE_NBR STORE_NBR1 
      ,FF.STORE_STATE_CD STORE_STATE_CD1 
      ,FF.TRANS_AMOUNT TRANS_AMOUNT1 
      ,FF.TRANS_DATE TRANS_DATE1 
      ,FF.TRANS_TIME TRANS_TIME1 
      ,FF.TERM_NBR TERM_NBR1 
      ,FF.TRANS_NBR TRANS_NBR1 
      ,FF.EMPLOYEE_NBR EMPLOYEE_NBR1 
      ,POS.TRANSACTION_TYPE TRANSACTION_TYPE2
      ,POS.GIFT_CARD_NBR GIFT_CARD_NBR2 
      ,POS.DIVISION_NBR DIVISION_NBR2 
      ,POS.DISTRICT_NBR DISTRICT_NBR2 
      ,POS.AREA_NBR AREA_NBR2 
      ,POS.STORE_NBR STORE_NBR2 
      ,POS.STORE_STATE_CD STORE_STATE_CD2 
      ,POS.TRANS_AMOUNT TRANS_AMOUNT2 
      ,POS.TRANS_DATE TRANS_DATE2 
      ,POS.TRANS_TIME TRANS_TIME2 
      ,POS.TERM_NBR TERM_NBR2 
      ,LPAD(POS.TRANS_NBR, 5, '0') TRANS_NBR2 
      ,POS.EMPLOYEE_NBR EMPLOYEE_NBR2
  FROM (SELECT * FROM FF_GIFT_CARD_POS_TRANS WHERE LOAD_DATE = TRUNC(SYSDATE)) FF
       FULL OUTER JOIN UAR_GIFT_CARD_POS_TRANS POS
    ON FF.GIFT_CARD_NBR = POS.GIFT_CARD_NBR
       AND FF.STORE_NBR = POS.STORE_NBR
       AND FF.TRANS_NBR = LPAD(POS.TRANS_NBR, 5, '0')
 WHERE FF.GIFT_CARD_NBR IS NULL OR
       POS.GIFT_CARD_NBR IS NULL OR
       FF.STORE_NBR IS NULL OR
       POS.STORE_NBR IS NULL OR
       FF.TRANS_NBR IS NULL OR
       POS.TRANS_NBR IS NULL
      OR NVL(FF.TRANSACTION_TYPE, 'NullValue') <> NVL(POS.TRANSACTION_TYPE, 'NullValue')
      OR NVL(FF.DIVISION_NBR 	 , 'NullValue') <> NVL(POS.DIVISION_NBR 	, 'NullValue') 
      OR NVL(FF.DISTRICT_NBR 	 , 'NullValue') <> NVL(POS.DISTRICT_NBR 	, 'NullValue') 
      OR NVL(FF.AREA_NBR        , 'NullValue') <> NVL(POS.AREA_NBR        , 'NullValue')
      OR NVL(FF.STORE_STATE_CD  , 'NullValue') <> NVL(POS.STORE_STATE_CD  , 'NullValue')
      OR NVL(FF.TRANS_AMOUNT    , 'NullValue') <> NVL(POS.TRANS_AMOUNT    , 'NullValue')
      OR NVL(FF.TRANS_DATE      , 'NullValue') <> NVL(POS.TRANS_DATE      , 'NullValue')
      OR NVL(FF.TRANS_TIME      , 'NullValue') <> NVL(POS.TRANS_TIME      , 'NullValue')
      OR NVL(FF.TERM_NBR        , 'NullValue') <> NVL(POS.TERM_NBR        , 'NullValue')
      OR NVL(FF.EMPLOYEE_NBR    , 'NullValue') <> NVL(POS.EMPLOYEE_NBR    , 'NullValue');
      
v_file_name                         VARCHAR2(100) := 'POSXML_GIFT_CARD_DIFF';
v_file_path                         VARCHAR2(100);
v_header                            CLOB;
v_gc_rec1                           CLOB;
v_gc_rec2                           CLOB;
v_gc_diff_file                      utl_file.file_type;
v_rec                               c_legacy%ROWTYPE;
--v_gift_card_reconcile_data          gift_card_reconcile_data%ROWTYPE;

BEGIN
    v_file_path := ccn_common_tools.get_datafile_path_fnc(g_schema);

    v_gc_diff_file := utl_file.fopen ( v_file_path
                                                  ,v_file_name || TO_CHAR(SYSDATE,'_MMDDYY') ||'.csv'
                                                  ,'W' 
                                                  ,32767); 

    v_header   :=    'IN_TABLE'                               ||','||
                     'TRANSACTION_TYPE'                       ||','||
                     'GIFT_CARD_NBR'                          ||','||
                     'DIVISION_NBR'                           ||','||
                     'DISTRICT_NBR'                           ||','||
                     'AREA_NBR'                               ||','||              
                     'STORE_NBR'                              ||','||
                     'STORE_STATE_CD'                         ||','||
                     'TRANS_AMOUNT'                           ||','||
                     'TRANS_DATE'                             ||','||
                     'TRANS_TIME'                             ||','||
                     'TERM_NBR'                               ||','||
                     'TRANS_NBR'                              ||','||
                     'EMPLOYEE_NBR'                                          
                     ;  


    UTL_FILE.PUT_LINE(v_gc_diff_file, v_header, TRUE);

    FOR v_rec IN c_legacy LOOP
               
        v_gc_rec1 :=             'LEGACY'||g_separator
                                 ||'"'||v_rec.TRANSACTION_TYPE1||'"'|| CHR(9) ||g_separator 
                                 ||'"'||v_rec.GIFT_CARD_NBR1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.DIVISION_NBR1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.DISTRICT_NBR1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.AREA_NBR1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.STORE_NBR1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.STORE_STATE_CD1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TRANS_AMOUNT1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TRANS_DATE1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TRANS_TIME1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TERM_NBR1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TRANS_NBR1||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.EMPLOYEE_NBR1||'"'|| CHR(9) ||g_separator
                                 ;
                                
          
        v_gc_rec2 :=             'POS'||g_separator
                                 ||'"'||v_rec.TRANSACTION_TYPE2||'"'|| CHR(9) ||g_separator 
                                 ||'"'||v_rec.GIFT_CARD_NBR2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.DIVISION_NBR2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.DISTRICT_NBR2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.AREA_NBR2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.STORE_NBR2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.STORE_STATE_CD2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TRANS_AMOUNT2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TRANS_DATE2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TRANS_TIME2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TERM_NBR2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.TRANS_NBR2||'"'|| CHR(9) ||g_separator
                                 ||'"'||v_rec.EMPLOYEE_NBR2||'"'|| CHR(9) ||g_separator
                                 ;
                    
        UTL_FILE.PUT_LINE(v_gc_diff_file, v_gc_rec1, TRUE);
            
        UTL_FILE.PUT_LINE(v_gc_diff_file, v_gc_rec2, TRUE);

--        IF v_rec.GIFT_CARD_NBR1 IS NOT NULL AND v_rec.GIFT_CARD_NBR2 IS NOT NULL 
--        THEN 
--           v_gift_card_reconcile_data.TRANSACTION_TYPE := v_rec.TRANSACTION_TYPE1;
--           v_gift_card_reconcile_data.GIFT_CARD_NBR    := v_rec.GIFT_CARD_NBR1;
--           v_gift_card_reconcile_data.DIVISION_NBR     := v_rec.DIVISION_NBR1;
--           v_gift_card_reconcile_data.DISTRICT_NBR     := v_rec.DISTRICT_NBR1;
--           v_gift_card_reconcile_data.AREA_NBR         := v_rec.AREA_NBR1;
--           v_gift_card_reconcile_data.STORE_NBR        := v_rec.STORE_NBR1;
--           v_gift_card_reconcile_data.STORE_STATE_CD   := v_rec.STORE_STATE_CD1;
--           v_gift_card_reconcile_data.TRANS_AMOUNT     := v_rec.TRANS_AMOUNT1;
--           v_gift_card_reconcile_data.TRANS_DATE       := v_rec.TRANS_DATE1;
--           v_gift_card_reconcile_data.TRANS_TIME       := v_rec.TRANS_TIME1;
--           v_gift_card_reconcile_data.TERM_NBR         := v_rec.TERM_NBR1;
--           v_gift_card_reconcile_data.TRANS_NBR        := v_rec.TRANS_NBR1;
--           v_gift_card_reconcile_data.EMPLOYEE_NBR     := v_rec.EMPLOYEE_NBR1;
--        
--        ELSIF v_rec.GIFT_CARD_NBR1 IS NULL 
--        THEN
--           v_gift_card_reconcile_data.TRANSACTION_TYPE := v_rec.TRANSACTION_TYPE2;
--           v_gift_card_reconcile_data.GIFT_CARD_NBR    := v_rec.GIFT_CARD_NBR2;
--           v_gift_card_reconcile_data.DIVISION_NBR     := v_rec.DIVISION_NBR2;
--           v_gift_card_reconcile_data.DISTRICT_NBR     := v_rec.DISTRICT_NBR2;
--           v_gift_card_reconcile_data.AREA_NBR         := v_rec.AREA_NBR2;
--           v_gift_card_reconcile_data.STORE_NBR        := v_rec.STORE_NBR2;
--           v_gift_card_reconcile_data.STORE_STATE_CD   := v_rec.STORE_STATE_CD2;
--           v_gift_card_reconcile_data.TRANS_AMOUNT     := v_rec.TRANS_AMOUNT2;
--           v_gift_card_reconcile_data.TRANS_DATE       := v_rec.TRANS_DATE2;
--           v_gift_card_reconcile_data.TRANS_TIME       := v_rec.TRANS_TIME2;
--           v_gift_card_reconcile_data.TERM_NBR         := v_rec.TERM_NBR2;
--           v_gift_card_reconcile_data.TRANS_NBR        := v_rec.TRANS_NBR2;
--           v_gift_card_reconcile_data.EMPLOYEE_NBR     := v_rec.EMPLOYEE_NBR2;
--           
--        ELSIF v_rec.GIFT_CARD_NBR2 IS NULL 
--        THEN
--           v_gift_card_reconcile_data.TRANSACTION_TYPE := v_rec.TRANSACTION_TYPE1;
--           v_gift_card_reconcile_data.GIFT_CARD_NBR    := v_rec.GIFT_CARD_NBR1;
--           v_gift_card_reconcile_data.DIVISION_NBR     := v_rec.DIVISION_NBR1;
--           v_gift_card_reconcile_data.DISTRICT_NBR     := v_rec.DISTRICT_NBR1;
--           v_gift_card_reconcile_data.AREA_NBR         := v_rec.AREA_NBR1;
--           v_gift_card_reconcile_data.STORE_NBR        := v_rec.STORE_NBR1;
--           v_gift_card_reconcile_data.STORE_STATE_CD   := v_rec.STORE_STATE_CD1;
--           v_gift_card_reconcile_data.TRANS_AMOUNT     := v_rec.TRANS_AMOUNT1;
--           v_gift_card_reconcile_data.TRANS_DATE       := v_rec.TRANS_DATE1;
--           v_gift_card_reconcile_data.TRANS_TIME       := v_rec.TRANS_TIME1;
--           v_gift_card_reconcile_data.TERM_NBR         := v_rec.TERM_NBR1;
--           v_gift_card_reconcile_data.TRANS_NBR        := v_rec.TRANS_NBR1;
--           v_gift_card_reconcile_data.EMPLOYEE_NBR     := v_rec.EMPLOYEE_NBR1;
--        END IF;
--
--        v_gift_card_reconcile_data.DATA_SOURCE  := 'LEGACY';
--        v_gift_card_reconcile_data.LOAD_DATE    := SYSDATE;
--        v_gift_card_reconcile_data.PROCESSED_YN := 'N';
--        v_gift_card_reconcile_data.CREATE_DT    := SYSDATE;
--        v_gift_card_reconcile_data.UPDATE_DT    := SYSDATE;
--        v_gift_card_reconcile_data.COMMENTS     := NULL;
--
--        v_gift_card_reconcile_data.CHECKSUM := v_gift_card_reconcile_data.TRANSACTION_TYPE
--                                               ||v_gift_card_reconcile_data.DIVISION_NBR 	
--                                               ||v_gift_card_reconcile_data.DISTRICT_NBR 	
--                                               ||v_gift_card_reconcile_data.AREA_NBR        
--                                               ||v_gift_card_reconcile_data.STORE_STATE_CD  
--                                               ||v_gift_card_reconcile_data.TRANS_AMOUNT    
--                                               ||v_gift_card_reconcile_data.TRANS_DATE      
--                                               ||v_gift_card_reconcile_data.TRANS_TIME      
--                                               ||v_gift_card_reconcile_data.TERM_NBR        
--                                               ||v_gift_card_reconcile_data.EMPLOYEE_NBR;
--
--        INSERT INTO GIFT_CARD_RECONCILE_DATA VALUES (v_gift_card_reconcile_data);
                                
    END LOOP;
    
   
    IF UTL_FILE.IS_OPEN(v_gc_diff_file) THEN
      UTL_FILE.FCLOSE(v_gc_diff_file);
    END IF;
    COMMIT;

--EXCEPTION
--WHEN OTHERS THEN
--        ERRPKG.INSERT_ERROR_LOG_SP(SQLCODE
--                                   ,'POS_GIFT_CARD_DIFF_sp'
--                                   ,SQLERRM
--                                   ,'000000'
--                                   ,'0000000000'
--                                   ,NULL);

END POS_GIFT_CARD_DIFF_sp;

END POS_GIFT_CARD_DIFF_PKG;