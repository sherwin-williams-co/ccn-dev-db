---FIXING HIERARCHY_DETAIL FOR GLOBAL_HIERARCHY WITH DUPLICATES, COST CENTER ATTACHED TO MULTIPLE GLOBAL HIERARCHY, 
---AND NULL HRCHY_DTL_NEXT_LVL_VAL ALTHOUGH IT IS MAPPED TO CHILD RECORD 
---nxk927 CCN Project....
/********************************************
 SELECT * FROM HIERARCHY_DETAIL where HRCHY_DTL_NEXT_LVL_VAL = '0101020313AA0101758343';
 SELECT * FROM HIERARCHY_DETAIL where HRCHY_DTL_NEXT_LVL_VAL = '0101020812AA010175Q455';
 SELECT * FROM HIERARCHY_DETAIL where HRCHY_DTL_NEXT_LVL_VAL = '0101030310AA010175Q536';
 select * from HIERARCHY_DETAIL 
  WHERE HRCHY_DTL_CURR_ROW_VAL IN ('789265', '789261','789262','789263','789264','789265','789266',
                                   '789267','789268','789293','789295','789653','789865')
    AND HRCHY_HDR_NAME = 'GLOBAL_HIERARCHY';

SELECT *
  FROM HIERARCHY_DETAIL HD
 WHERE HRCHY_DTL_NEXT_LVL_VAL IS NULL
   AND EXISTS (SELECT 1
                 FROM HIERARCHY_DETAIL
                WHERE HRCHY_HDR_NAME         = HD.HRCHY_HDR_NAME
                  AND HRCHY_DTL_LEVEL        = HD.HRCHY_DTL_LEVEL
                  AND HRCHY_DTL_PREV_LVL_VAL = HD.HRCHY_DTL_PREV_LVL_VAL
                  AND HRCHY_DTL_CURR_LVL_VAL = HD.HRCHY_DTL_CURR_LVL_VAL
                  AND HRCHY_DTL_NEXT_LVL_VAL IS NOT NULL);
********************************************/
BEGIN
    CCN_BATCH_PKG.LOCK_DATABASE_SP();
END;
/
DECLARE
BEGIN
--SELECTING ALL THOSE RECORDS HAVING HRCHY_DTL_NEXT_LVL_VAL AS NULL ALTHOUGH IT IS MAPPED TO CHILD RECORD 
FOR REC IN (SELECT HD.*, ROWID
              FROM HIERARCHY_DETAIL HD
             WHERE HRCHY_DTL_NEXT_LVL_VAL IS NULL
               AND EXISTS (SELECT 1
                             FROM HIERARCHY_DETAIL
                            WHERE HRCHY_HDR_NAME         = HD.HRCHY_HDR_NAME
                              AND HRCHY_DTL_LEVEL        = HD.HRCHY_DTL_LEVEL
                              AND HRCHY_DTL_PREV_LVL_VAL = HD.HRCHY_DTL_PREV_LVL_VAL
                              AND HRCHY_DTL_CURR_LVL_VAL = HD.HRCHY_DTL_CURR_LVL_VAL
                              AND HRCHY_DTL_NEXT_LVL_VAL IS NOT NULL)) LOOP
--DELETING ALL THOSE RECORDS HAVING HRCHY_DTL_NEXT_LVL_VAL AS NULL ALTHOUGH IT IS MAPPED TO CHILD RECORD 
    DELETE 
      FROM HIERARCHY_DETAIL
     WHERE HRCHY_HDR_NAME         = rec.HRCHY_HDR_NAME
       AND HRCHY_DTL_LEVEL        = rec.HRCHY_DTL_LEVEL
       AND HRCHY_DTL_PREV_LVL_VAL = rec.HRCHY_DTL_PREV_LVL_VAL
       AND HRCHY_DTL_CURR_LVL_VAL = rec.HRCHY_DTL_CURR_LVL_VAL
       AND ROWID                  = rec.ROWID
       AND HRCHY_DTL_NEXT_LVL_VAL IS NULL;
COMMIT;	 
END LOOP;
 --SELECTING THE DUPLICATES FOR 8TH LEVEL FOR GLOBAL_HIERARCHY 
FOR rec1 IN (SELECT HD.*, rowid
              FROM HIERARCHY_DETAIL HD
             WHERE HD.ROWID > ANY (SELECT HD1.ROWID
                                     FROM HIERARCHY_DETAIL HD1
                                    WHERE HD.HRCHY_HDR_NAME = HD1.HRCHY_HDR_NAME
                                      AND HD.HRCHY_DTL_PREV_LVL_VAL = HD1.HRCHY_DTL_PREV_LVL_VAL
                                      AND HD.HRCHY_DTL_CURR_LVL_VAL = HD1.HRCHY_DTL_CURR_LVL_VAL
                                      AND HD.HRCHY_DTL_NEXT_LVL_VAL = HD1.HRCHY_DTL_NEXT_LVL_VAL)
               AND HD.HRCHY_DTL_LEVEL = '8'
               AND HD.HRCHY_HDR_NAME = 'GLOBAL_HIERARCHY') LOOP
 --DELETING THE DUPLICATES FOR 8TH LEVEL FOR GLOBAL_HIERARCHY 
    DELETE 
      FROM HIERARCHY_DETAIL
     WHERE HRCHY_HDR_NAME         = rec1.HRCHY_HDR_NAME
       AND HRCHY_DTL_LEVEL        = rec1.HRCHY_DTL_LEVEL
       AND HRCHY_DTL_PREV_LVL_VAL = rec1.HRCHY_DTL_PREV_LVL_VAL
       AND HRCHY_DTL_CURR_LVL_VAL = rec1.HRCHY_DTL_CURR_LVL_VAL
       AND HRCHY_DTL_NEXT_LVL_VAL = rec1.HRCHY_DTL_NEXT_LVL_VAL
       AND ROWID                  = rec1.ROWID;  
COMMIT;		   
END LOOP;       

--SELECTING THE ONES WHICH ARE ATTACHED TO MULTIPLE GLOBAL HIERARCHY AT 9TH LEVEL WITH LEAST EFFECTIVE DATES
--AS WE WILL BE DELETING THE 9TH LEVEL WE HAVE TO DELETE THE 8TH LEVEL AND UPDATING THOSE
--RECORDS WHICH HAVE CHILD RECORDS ATTACHED TO THIS LEVEL
FOR rec2 IN (SELECT HD.*, ROWID
              FROM HIERARCHY_DETAIL HD
             WHERE HRCHY_HDR_NAME = 'GLOBAL_HIERARCHY'
             AND HRCHY_DTL_LEVEL = '9'
             AND HRCHY_DTL_CURR_LVL_VAL IN  ('0101090790010101789261','0101090795ZZ0101789262','0101090790010101789263', '0101090790010101789264',
                                             '0101090790010101789265', '0101090790010101789266','0101090790010101789267', '0101090790010101789268',
                                             '0101090395ZZ0101789293', '0101090437010101789295', '0101090195ZZ0101789653', '0101090294010101789865')) LOOP
 --DELETING THE ONES WHICH ARE ATTACHED TO MULTIPLE GLOBAL HIERARCHY AT 9TH LEVEL WITH LEAST EFFECTIVE DATES
      DELETE 
        FROM HIERARCHY_DETAIL
       WHERE HRCHY_HDR_NAME         = rec2.HRCHY_HDR_NAME
         AND HRCHY_DTL_LEVEL        = rec2.HRCHY_DTL_LEVEL
         AND HRCHY_DTL_PREV_LVL_VAL = rec2.HRCHY_DTL_PREV_LVL_VAL
         AND HRCHY_DTL_CURR_LVL_VAL = rec2.HRCHY_DTL_CURR_LVL_VAL
         AND HRCHY_DTL_NEXT_LVL_VAL = rec2.HRCHY_DTL_NEXT_LVL_VAL
         AND ROWID                  = rec2.ROWID;		 
COMMIT;			 
END LOOP;

--SELECTING THE 8th LEVEL FOR THE ONES WHICH WERE ATTACHED TO MULTIPLE GLOBAL HIERARCHY AT 9TH LEVEL
FOR rec3 IN (SELECT HD.*, ROWID 
               FROM HIERARCHY_DETAIL HD
              WHERE HRCHY_HDR_NAME = 'GLOBAL_HIERARCHY'
                AND HRCHY_DTL_LEVEL = '8'
                AND HRCHY_DTL_NEXT_LVL_VAL IN  ('0101090790010101789261','0101090790010101789263', '0101090790010101789264','0101090790010101789265', 
                                                '0101090790010101789266','0101090790010101789267', '0101090790010101789268','0101090395ZZ0101789293',
                                                '0101090437010101789295', '0101090195ZZ0101789653', '0101090294010101789865')) LOOP
                                                
--DELETING 8th LEVEL FOR THE ONES WHICH WERE ATTACHED TO MULTIPLE GLOBAL HIERARCHY AT 9TH LEVEL
    DELETE 
      FROM HIERARCHY_DETAIL
     WHERE HRCHY_HDR_NAME         = rec3.HRCHY_HDR_NAME
       AND HRCHY_DTL_LEVEL        = rec3.HRCHY_DTL_LEVEL
       AND HRCHY_DTL_PREV_LVL_VAL = rec3.HRCHY_DTL_PREV_LVL_VAL
       AND HRCHY_DTL_CURR_LVL_VAL = rec3.HRCHY_DTL_CURR_LVL_VAL
       AND HRCHY_DTL_NEXT_LVL_VAL = rec3.HRCHY_DTL_NEXT_LVL_VAL
	     AND ROWID                  = rec3.ROWID; 
COMMIT;		   
END LOOP;

---UPDATING HRCHY_DTL_NEXT_LVL_VAL FOR THE 8TH LEVEL FOR 789262 CC TO '~~~'
---AS THERE ARE CHILD RECORDS ATTACHED TO THIS LEVEL
UPDATE HIERARCHY_DETAIL 
   SET HRCHY_DTL_NEXT_LVL_VAL = '~~~'
 WHERE HRCHY_HDR_NAME         = 'GLOBAL_HIERARCHY'
   AND HRCHY_DTL_LEVEL        = '8'
   AND HRCHY_DTL_PREV_LVL_VAL = '0101090795ZZ01'
   AND HRCHY_DTL_CURR_LVL_VAL = '0101090795ZZ0101'
   AND HRCHY_DTL_NEXT_LVL_VAL = '0101090795ZZ0101789262';  
COMMIT;
END;
/

BEGIN
    CCN_BATCH_PKG.UNLOCK_DATABASE_SP();
END;
/

