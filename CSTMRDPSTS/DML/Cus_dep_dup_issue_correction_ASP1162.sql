/*
Below script will resolve the duplciates issue that happened due to 0 run cycles

Created : 11/12/2018 jxc517 CCN Project Team....
Changed :
*/

DECLARE
    CURSOR CUST_DEPOSITS_ACCT IS
        SELECT DISTINCT CUSTOMER_ACCOUNT_NUMBER
          FROM CUSTOMER_DEPOSIT_HEADER
         WHERE CUSTOMER_ACCOUNT_NUMBER IN (
          '274653674','799969365','421627001','902369180','523031524','924969819','997758040','245913488','675911754','934225699','237466487','797941127','537256968','424087633','993473412','557528593','423243146','422245688','665798740','256882010','291316628','268807989','244973186','277894242','266119106','662169945','293356788','532702222','1','548670272','386916639','241083799','423526334','246143903','797990124','264073081','798621033','524324274','797920519','261568026','517694220','422789594','267677185','798992483','248532996','339754822','420187486','264035999','296859556','999552722','258409424','797942182','424632784','286877931','267573988','426340220','673169587','308874965','545022584','666890223','260732227','575028493','281877928','424344489','266926476','798073599','420624553','798563037','260414867','254862584','322818543','424160588','799934609','237333117','346685803','260201025','546536400','295411805','262139165','246863880','273363648','931548168','799516760','282739176','425594231','264063462','246657043','799159751','244949657','527084974','546727553','937345510','672874815','424986560','797943453','551308521','549434900','987407988','101347565','798973921','676227580','555068790','798695581','269004941','979735537','930359146','798300034','564508935','213282478','240220814','306234535','426125076','237139241','262528615','241216399','576298210','797920816','797938925','422075549','426144044','308089259','797912763','237293444','900869348','425464492','260427422','520189069','242821940','518957410','239776917','253468086','424918340','306300682','542351242','676096639','969565621','309732667','307060582','278823059','423795574','245891718','799503032','285846234','797920352','237287040','260898713','249000795','798582326','320317449','239287147','254008626','675573877','798197042','799105242','423429463','260514294','799296538','990650004','382206274','997973896','325775179','361098528','100807866','799042544','904060423','797924495','311095343','584629786','292179181','674432885','797937554','324084003','238293963','248023590','667635155','556435477','275486538','242602316','310301064','252351242','239483670','667665673','584686034','264039801','247676380','258437441','321494296','237772322','248547564','946421716','285625869','520083726','798028254','563912542','850225335','585580723','283814853','906030937','343585766','928895184','424689172','327469896','798613436','423391622','422132662','289228439','426658365','426182226','516037058','241203090','665337259','297469108','339521783','659086656','190511766','421036856','661830091','666055819','905419487','326996311','425488095','799599907','991225228','799871884','535777239','422213116','797957065','667012918','424308476','967903956','943389494','242579316','927809939','799076120','242404416','577914724','524956661','305627069','271484263','676072994','304739485','248046260','799027263','295373476','797934700','421008657','382749588','323031617','671955490','799029665','527316046','532765799','321399834','296798747','423860329','666884689','282776780','595468018','422232306','521336719','671603488','353154354','264654930','239410947','218231561','517217261','271184087','272844895','798084034','568916837','423949346','918558933','632158507','949353106','480477025','291849529','421934001','421318940','798452108','531846921','247553696','426231908','797940145','301148623','249214974','101603405','611991845','797934015','237314190','244833588','586532004','675057392','974924862','277584405','238228738','558431672','973622178','943009860','799936620','574440012','611749581','336260203','665520219','924347818','666699772','241604842','527827992','248563496','293830824','247605678','301834941','102247269','580296267','240292367','537391708','280646712','671577492','798492880','675757967','798440533','421736430','248562894','424756435','420615726','528750524','305758260','671654135','280349879','797944337','909682361','986867471','537483109','276777463','246375927','939326492','102664133','595050881','797918125','239447527','906019427','551573678','797970522','675714463','230358129','548835198','241926021','582464459','550211437','554645945','421808692','290358621','252271499','798813226','524042934','798679098','572460111','595855198','100327436','947009171','281143602','252744917','242576437','277378949','425061629','238406227','577030711','941998791','248501728','527918064','247521578','673641999','799048913','243323409','669341190','670338250','288726367','274485333','797914777','294630991','590473674','425994845','663083814','547601690','101237097','904464971','422483131','421711524','421055955','231468802','425602299','277848545','798143871','799333687','299982603','529139966','531210870','798149555','248697658','799292131','260452586','526937636','677689689','583695721','426564761','993453075','798274619','580709145','423162437','667471817','250239167','251762449','230820615','305367997','267735538','348550757','424202554','278049846','424911113','305806622','549946242','978582146','423075514','265872937','675063168','219916749','424635571','266508761','425592797','101758738','798925798','797932381','495552028','271005506','246106538','960697118','523328904','529423717','242503480','570764001','671072007','307103507','399760693','667536668','533043352','304223670','420386849','247878119','534966759','670431212','556357820','272395575','423006774','926518473','111731907','271575474','549333565','423618321','245586623','325615326','666004338','931298020','983415969','308723238','246886709','289188617','798483210','100041706','343142600','661471532','250522448','426267456','421132812','346113830','238115232','240009878','543647010','666930300','532117496','302632096','798512711','799005327','662213941','525350021','323443986','577723018','361132392','421518549','676090731','304005135','322748138','257371526','540027851','697074623','244578332','253404214','102487246','249252594','674963764','675833701','582866380','421481490','250566155','294383047','797989530','673151544','334107505','274636752','546103144','425168770','999241367','798468427','966450777','426593638','420294589','798263315','246705289','538337791','190634790','537348633','254159718','424622801','424763076','251081808','425354347','256416744','423241710','594539561','589569201','423984194','529117624','295460208','420532566','526439153','925610685','322512096','421700444','102482700','351587688','424795003','540131174','270707920','797934379','529180259','797937430','538750555','797956950','962343489','799281761','422521674','797928751','583531900','253498315','421136383','365095108','423014828','422424135','424265049','273494203','247303043','251336194','676264146','797933173','424914737','985143049','100781079','299594028','797923356','241423847','656431764','425468287','244846341','548434042','285247078','595992892','797943552','799123997','426341442','997922190','257353433','230156655','292769965','660899931','936202936','540872579','244598504','236909149','798168001','938747169','923391031','426562666','522826395','521620419','422724435','283334027','535680193','299371666','533936209','425663770','711855387','248009987','294797915','233719608','670709443','529672271','425790136','934598293','272076043','425448768','495597858','611749383','270522139','589436369','524480019','260932413','32611790','670792597','190923391','243812377','100657089','797957115','349131318','797931839','421121138','658356019','426304796','797914397','946428216','331606392','527740740','308667773','420112427','250627098','670346923','287002430','333656239','296124597','251412508','239475155','424827715','253946586','548287580','798804712','797993136','426580478','529217192','797931342','277942728','304538838','525798518','290636414','676235831','797939394','423172469','524028081','548471291','236980645','548379874','285699930','673445854','545569238','906154984','798072286','525897393','568313100','279098743','238195788','540665890','421914219','540470861','253527709','306436072','561405341','799561584','248960361','531424836','256718636','798421426','247919889','797931698','279111884','248336547','612030726','351169834','799776612','986963486','557051216','422507400','578274318','309067197','798098455','262690605','420904070','359416674','250560851'
          );

    CURSOR CUST_DEPOSITS(IN_ACOUNT     VARCHAR2) IS
       SELECT A.*,
              rowid row_id
         FROM CUSTOMER_DEPOSIT_DETAILS A
        WHERE /*TRANSACTION_TYPE = 'REDEMPTION'
         AND */TRANSACTION_DATE BETWEEN '01-OCT-2017' AND '31-AUG-2018'
         AND CUSTOMER_ACCOUNT_NUMBER     = IN_ACOUNT
         AND CSTMR_DPST_SALES_LN_ITM_AMT <> (SELECT SUM(EXTENDED_PRICE)
                                               FROM CCN_SALES_LINES_T
                                              WHERE NON_MERCH_CODE = '05'
                                                AND RLS_RUN_CYCLE  = A.RLS_RUN_CYCLE
                                                AND TRAN_GUID      = A.TRANSACTION_GUID);
                                                
   --variable declaration
   V_CREDIT_ROW     CUST_DEP_CREDIT_DETAILS%ROWTYPE;
   V_REDEMPTION_ROW CUST_DEP_REDEMPTION_DETAILS%ROWTYPE;
   V_RUNNING_TOTAL  NUMBER := 0;
   V_ORIG_DEP_NBR   CUSTOMER_DEPOSIT_DETAILS.TRANSACTION_NUMBER%TYPE;
   V_ORIG_TERM_NBR  CUSTOMER_DEPOSIT_DETAILS.TERMINAL_NUMBER%TYPE;
   V_ORIG_TRAN_DATE CUSTOMER_DEPOSIT_DETAILS.TRANSACTION_DATE%TYPE;
BEGIN
    FOR rec in CUST_DEPOSITS_ACCT LOOP
        FOR rec2 in CUST_DEPOSITS(rec.CUSTOMER_ACCOUNT_NUMBER) LOOP
            UPDATE CUSTOMER_DEPOSIT_DETAILS D
               SET D.CSTMR_DPST_SALES_LN_ITM_AMT = (rec2.CSTMR_DPST_SALES_LN_ITM_AMT/2)
             WHERE rowid = rec2.row_id;  
        END LOOP;

        DELETE FROM CUST_DEP_CREDIT_DETAILS C     WHERE C.CUSTOMER_ACCOUNT_NUMBER = rec.CUSTOMER_ACCOUNT_NUMBER;
        DELETE FROM CUST_DEP_REDEMPTION_DETAILS R WHERE R.CUSTOMER_ACCOUNT_NUMBER = rec.CUSTOMER_ACCOUNT_NUMBER;
        V_RUNNING_TOTAL := 0;

        FOR rec1 in (SELECT * FROM CUSTOMER_DEPOSIT_DETAILS WHERE CUSTOMER_ACCOUNT_NUMBER = rec.CUSTOMER_ACCOUNT_NUMBER ORDER BY TRAN_TIMESTAMP) LOOP
            BEGIN
                V_RUNNING_TOTAL := V_RUNNING_TOTAL + rec1.CSTMR_DPST_SALES_LN_ITM_AMT;
                UPDATE CUSTOMER_DEPOSIT_DETAILS
                   SET CUSTOMER_NET_BALANCE = V_RUNNING_TOTAL
                 WHERE TRANSACTION_GUID     = rec1.TRANSACTION_GUID
                   AND CUSTOMER_NET_BALANCE <> V_RUNNING_TOTAL;

                 IF rec1.TRANSACTION_TYPE = 'DEPOSIT' THEN
                    V_CREDIT_ROW.CREDIT_ID                := SEQ_CREDIT_ID.nextval;
                    V_CREDIT_ROW.COST_CENTER_CODE         := rec1.COST_CENTER_CODE;
                    V_CREDIT_ROW.CUSTOMER_ACCOUNT_NUMBER  := rec1.CUSTOMER_ACCOUNT_NUMBER;
                    V_CREDIT_ROW.TRANSACTION_NUMBER       := rec1.TRANSACTION_NUMBER;
                    V_CREDIT_ROW.TRANSACTION_DATE         := rec1.TRANSACTION_DATE;
                    V_CREDIT_ROW.TERMINAL_NUMBER          := rec1.TERMINAL_NUMBER;           
                    V_CREDIT_ROW.DEPOSIT_REMAINING_BAL    := rec1.CSTMR_DPST_SALES_LN_ITM_AMT;
                    V_CREDIT_ROW.TRAN_TIMESTAMP           := rec1.TRAN_TIMESTAMP;
                    V_CREDIT_ROW.LOAD_DATE                := rec1.LOAD_DATE;

                    TABLE_IU_PKG.CUST_DEPOSIT_CREDIT_I_SP(V_CREDIT_ROW);
                 ELSIF rec1.TRANSACTION_TYPE = 'REDEMPTION' THEN
                    CUSTOMER_DEPOSIT_MAINT_PKG.ORIG_DEP_REM_BAL_UPD( rec1.CSTMR_DPST_SALES_LN_ITM_AMT, rec1.CUSTOMER_ACCOUNT_NUMBER, rec1.TRANSACTION_DATE, V_ORIG_DEP_NBR, V_ORIG_TERM_NBR, V_ORIG_TRAN_DATE);
                    V_REDEMPTION_ROW.REDEMPTION_ID                  := SEQ_REDEMPTION_ID.nextval;
                    V_REDEMPTION_ROW.COST_CENTER_CODE               := rec1.COST_CENTER_CODE;
                    V_REDEMPTION_ROW.CUSTOMER_ACCOUNT_NUMBER        := rec1.CUSTOMER_ACCOUNT_NUMBER;
                    V_REDEMPTION_ROW.TRANSACTION_NUMBER             := rec1.TRANSACTION_NUMBER;
                    V_REDEMPTION_ROW.TRANSACTION_DATE               := rec1.TRANSACTION_DATE;
                    V_REDEMPTION_ROW.TERMINAL_NUMBER                := rec1.TERMINAL_NUMBER;
                    V_REDEMPTION_ROW.ORIGINAL_DEP_TRANS_NBR         := V_ORIG_DEP_NBR;  
                    V_REDEMPTION_ROW.ORIGINAL_DEP_TERM_NBR          := V_ORIG_TERM_NBR;
                    V_REDEMPTION_ROW.ORIGINAL_DEP_TRAN_DATE         := V_ORIG_TRAN_DATE;
                    V_REDEMPTION_ROW.TRAN_TIMESTAMP                 := rec1.TRAN_TIMESTAMP;
                    V_REDEMPTION_ROW.LOAD_DATE                      := rec1.LOAD_DATE;

                    TABLE_IU_PKG.CUST_DEPOSIT_REDEMPTION_I_SP(V_REDEMPTION_ROW);
                 ELSE
                   NULL;
                 END IF;
              EXCEPTION
                 WHEN OTHERS THEN
                      ERRPKG.INSERT_ERROR_LOG_SP( SQLCODE, 'LOAD_CUSTOMER_DEPOSIT_DETAILS', SQLERRM, rec1.COST_CENTER_CODE, rec1.CUSTOMER_ACCOUNT_NUMBER, 'CUSTOMER_DEPOSIT_DETAILS');
              END;
        END LOOP;
        COMMIT;
    END LOOP;
EXCEPTION
   WHEN OTHERS THEN
        ERRPKG.INSERT_ERROR_LOG_SP( SQLCODE, 'LOAD_CUSTOMER_DEPOSIT_DETAILS', SQLERRM, '000000', '000000000', '000000000');
END;